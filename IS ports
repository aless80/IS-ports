// ==UserScript==
// @name         IS ports
// @namespace    https://github.com/aless80/IS-ports
// @version      0.1
// @description  Add a small div on InterSystems web applications to be able to launch the same URL at a different port number
// @author       Alessandro Marin
// @match        
// @include      http://localhost:577*/csp/*
// @grant        none
// @exclude      http*$ZEN_POPUP=1*
// @exclude      http*://localhost:577*/csp/*$ZEN_POPUP=1*
// @exclude      http*://localhost:57772/csp/samples/_DeepSee.UI.Dialog.CubeSave.cls?$ZEN_POPUP=1&$ZEN_SOFTMODAL=1&MODE=savecube&CUBE=NamesUS&CLASS=Ale.NamesUSCube&DESC=Grabs%20the%20data%20in%20http%3A%2F%2Fwww2.census.gov%2Ftopics%2Fgenealogy%2F1990surnames%2Fdist.male.first%0D%0Acantaining%20the%20frequency%20of%20first%20Names%20in%20the%20US%20in%201990%2C%20or%20something%20like%20that*
// ==/UserScript==


function getPort() {
    var url=location.href;
    var port=url.split(":")[2].split("/")[0];
    return port;
}

function setPort(port) {
    var url=location.href;
    console.log("location.href=",url)
    var http=url.split("//",2)[0];
    var afterhttp=url.split("//",2)[1];
    var ip=afterhttp.split(":")[0];
    var afterip=afterhttp.split(":")[1];
    var portinurl=afterip.split("/")[0];
    var afterport=afterip.substr(portinurl.length);
    var newurl=http+"//"+ip+":"+port+afterport;
    console.log(newurl);
    location.href=newurl;
}
console.log("Tampermonkey script running on: "+location.href + " and port is: "+getPort())
var div = document.createElement("DIV");
// Create a <button> element
var btnp = document.createElement("BUTTON");
var btnm = document.createElement("BUTTON");
btnp.id="Ale_btnp";
btnm.id="Ale_btnm";
//Create an input field
var input = document.createElement("INPUT");
input.id="Ale_input";
input.value=getPort();
input.style.visibility = "hidden";
input.style.width="4px";
           
// Create text nodes and append them to the buttons
var tp = document.createTextNode("+");       
var tm = document.createTextNode("-");       
btnp.appendChild(tp);                                
btnm.appendChild(tm);
// Append stuff to the div
div.appendChild(btnm);
div.appendChild(btnp);
div.appendChild(input);
// Styles for the divs
div.style.position = "absolute";
div.style.left="450px";
div.style.top="2px";
div.style.backgroundColor="lightgrey";
div.style.padding="1px";
div.style.width="48px";
document.body.appendChild(div);
//Append onclick event
btnp.onclick=function(){changePort(+1);};
btnm.onclick=function(){changePort(-1);};
	

//variable to track the callback
var timeout;
//Launch url with new port number
function changePort(increment){
    clearTimeout(timeout);
    input.value=Number(input.value)+increment;
    input.style.visibility='visible';
    timeout=setTimeout(function(){setPort(input.value)},650)
}
//Clicking on div shows the input field
div.onclick=function(){
    console.log(input.style.visibility)
    
    if (input.style.visibility=='hidden'){
        input.style.width="40px";
        div.style.width="90px";
        input.style.visibility = "visible";
    } else if (input.style.visibility=='visible'){
        input.style.width="4px";
        div.style.width="49px";
        input.style.visibility = "hidden";
    }
}
//Press enter on input
input.onkeyup=function(){
    if (event.keyCode == 13){
        var port=this.value;
        if (port>57700 && port<57800)
            setPort(port);
    }
}
